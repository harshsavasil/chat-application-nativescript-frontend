"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var index_1 = require("./index");
// tslint:disable-next-line:no-var-requires
var Sqlite = require('nativescript-sqlite');
var DataBaseService = (function () {
    function DataBaseService() {
    }
    DataBaseService.prototype.createTables = function () {
        var _this = this;
        (new Sqlite(index_1.Config.dbName)).then(function (db) {
            _this.database = db;
            if (!_this.checkIfTableExist(index_1.Config.contactTableName)) {
                _this.createContactTable();
            }
            if (!_this.checkIfTableExist(index_1.Config.messageTableName)) {
                _this.createMessagesTable();
            }
        }, function (error) {
            alert('Could Not create a connection to DB.');
        });
    };
    DataBaseService.prototype.createContactTable = function () {
        (new Sqlite(index_1.Config.dbName)).then(function (db) {
            // tslint:disable-next-line:max-line-length
            db.execSQL(index_1.Config.contactsTableCreationQuery).then(function (id) {
                // tslint:disable-next-line:no-console
                console.log('Contacts TABLE CREATED SUCCESSFULLY');
                db.close();
            }, function (error) {
                // tslint:disable-next-line:no-console
                console.log('CREATE TABLE ERROR', error);
            });
        }, function (error) {
            // console.log('error in creating db connection.');
        });
    };
    DataBaseService.prototype.createMessagesTable = function () {
        (new Sqlite(index_1.Config.dbName)).then(function (db) {
            // tslint:disable-next-line:max-line-length
            db.execSQL(index_1.Config.messagesTableCreationQuery).then(function (id) {
                // tslint:disable-next-line:no-console
                console.log('Messages TABLE CREATED SUCCESSFULLY', id);
                db.close();
                // this.getChatMessagesFromService();
            }, function (error) {
                // tslint:disable-next-line:no-console
                console.log('Messages TABLE Could Not be CREATED', error);
            });
        }, function (error) {
            // console.log('error in creating db connection.');
        });
    };
    DataBaseService.prototype.checkIfTableExist = function (tableName) {
        var _this = this;
        // tslint:disable-next-line:max-line-length
        var distinctQuery = 'select DISTINCT tbl_name from sqlite_master where tbl_name = ?';
        (new Sqlite(index_1.Config.dbName)).then(function (db) {
            _this.database = db;
            var checkTableQuery = distinctQuery;
            _this.database.execSQL(checkTableQuery, [tableName])
                .then(function (resultset) {
                for (var row in resultset) {
                    if (resultset.hasOwnProperty('row')) {
                        return true;
                    }
                }
                return false;
            }, function (error) {
                return false;
            });
            return false;
        });
    };
    DataBaseService.prototype.insertIntoChats = function (chat) {
        var _this = this;
        var insertQuery = "\n          INSERT INTO contacts\n          ( number, name, avatar, text, type, muted,\n            lastSeen, unread, last_message_timestamp )\n          VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)";
        var updateQuery = "\n          UPDATE contacts\n          SET number = ?, name = ?,\n          avatar =?, text = ?, type = ?, muted = ?, lastSeen = ?, unread = ?,\n          last_message_timestamp = ?\n          WHERE number = ?\n        ";
        var insertJSON = [];
        insertJSON.push(chat.number);
        insertJSON.push(chat.contact.name);
        insertJSON.push(chat.contact.avatar);
        insertJSON.push(chat.text);
        insertJSON.push(chat.type);
        insertJSON.push(chat.muted);
        insertJSON.push(chat.when);
        insertJSON.push(chat.unread);
        insertJSON.push(chat.last_message_timestamp);
        (new Sqlite(index_1.Config.dbName)).then(function (db) {
            db.execSQL(insertQuery, insertJSON).then(function (id) {
                // tslint:disable-next-line:no-console
                console.log('INSERT RESULT', id);
            }, function (error) {
                // tslint:disable-next-line:no-console
                console.log('INSERT ERROR', error);
                var updateJSON = insertJSON;
                updateJSON.push(chat.number);
                _this.database.execSQL(updateQuery, updateJSON).then(function (id) {
                    // tslint:disable-next-line:no-console
                    console.log('UPDATE RESULT Chats', id);
                }, function (err) {
                    // tslint:disable-next-line:no-console
                    console.log('UPDATE ERROR', err);
                });
            });
            db.close();
        });
    };
    DataBaseService.prototype.insertIntoMessages = function (message) {
        var insertQuery = "\n            INSERT INTO messages\n            ( messageText, sender, createdTime, sent, contact)\n            VALUES (?, ?, ?, ?, ?)";
        // tslint:disable-next-line:max-line-length
        var insertJSON = [];
        insertJSON.push(message.text);
        insertJSON.push(parseInt(message.sender, 10));
        insertJSON.push(parseFloat(message.created));
        insertJSON.push(parseInt(message.sent, 10));
        insertJSON.push(message.contact);
        (new Sqlite(index_1.Config.dbName)).then(function (db) {
            db.execSQL(insertQuery, insertJSON).then(function (id) {
                // tslint:disable-next-line:no-console
                console.log('INSERT MEssage RESULT', id);
            }, function (error) {
                // tslint:disable-next-line:no-console
                console.log('INSERT ERROR', error);
            });
            db.close();
        });
    };
    DataBaseService.prototype.insertIntoMessagesWithMessageId = function (message) {
        var insertQuery = "\n            INSERT INTO messages\n            ( messageText, sender, createdTime, sent, contact, messageId)\n            VALUES (?, ?, ?, ?, ?, ?)";
        // tslint:disable-next-line:max-line-length
        var insertJSON = [];
        insertJSON.push(message.text);
        insertJSON.push(parseInt(message.sender, 10));
        insertJSON.push(parseFloat(message.created));
        insertJSON.push(parseInt(message.sent, 10));
        insertJSON.push(message.contact);
        insertJSON.push(message.message_id);
        (new Sqlite(index_1.Config.dbName)).then(function (db) {
            db.execSQL(insertQuery, insertJSON).then(function (id) {
                // tslint:disable-next-line:no-console
                console.log('INSERT MEssage RESULT', id);
            }, function (error) {
                // tslint:disable-next-line:no-console
                console.log('INSERT ERROR', error);
            });
            db.close();
        });
    };
    DataBaseService.prototype.updateStatusOfMessage = function (status, id) {
        (new Sqlite(index_1.Config.dbName)).then(function (db) {
            var updateQuery = "\n                UPDATE messages\n                SET sent = ?\n                WHERE id = ?";
            var updateJSON = [];
            updateJSON.push(status);
            updateJSON.push(id);
            db.execSQL(updateQuery, updateJSON).then(function (uniqid) {
                // tslint:disable-next-line:no-console
                console.log('UPDATE SENT STATUS OF MESSAGES', uniqid);
            }, function (err) {
                // tslint:disable-next-line:no-console
                console.log('UPDATE ERROR', err);
            });
            db.close();
        });
    };
    DataBaseService.prototype.updateSentTimeOfMessage = function (sentTime, id) {
        (new Sqlite(index_1.Config.dbName)).then(function (db) {
            var updateQuery = "\n                UPDATE messages\n                SET sentTime = ?\n                WHERE id = ?";
            var updateJSON = [];
            updateJSON.push(sentTime);
            updateJSON.push(id);
            db.execSQL(updateQuery, updateJSON).then(function (uniqid) {
                // tslint:disable-next-line:no-console
                console.log('UPDATE SENT STATUS OF MESSAGES', uniqid);
            }, function (err) {
                // tslint:disable-next-line:no-console
                console.log('UPDATE ERROR', err);
            });
            db.close();
        });
    };
    DataBaseService.prototype.updateDeliveryTimeOfMessage = function (deliveryTime, id) {
        (new Sqlite(index_1.Config.dbName)).then(function (db) {
            var updateQuery = "\n                UPDATE messages\n                SET deliveredTime = ?\n                WHERE id = ?";
            var updateJSON = [];
            updateJSON.push(deliveryTime);
            updateJSON.push(id);
            db.execSQL(updateQuery, updateJSON).then(function (uniqid) {
                // tslint:disable-next-line:no-console
                console.log('UPDATE SENT STATUS OF MESSAGES', uniqid);
            }, function (err) {
                // tslint:disable-next-line:no-console
                console.log('UPDATE ERROR', err);
            });
            db.close();
        });
    };
    DataBaseService.prototype.updateMessaeIdOfMessage = function (messageId, id) {
        (new Sqlite(index_1.Config.dbName)).then(function (db) {
            var updateQuery = "\n                UPDATE messages\n                SET messageId = ?\n                WHERE id = ?";
            var updateJSON = [];
            updateJSON.push(messageId);
            updateJSON.push(id);
            db.execSQL(updateQuery, updateJSON).then(function (uniqid) {
                // tslint:disable-next-line:no-console
                console.log('Message Id Updated OF MESSAGE', uniqid);
            }, function (err) {
                // tslint:disable-next-line:no-console
                console.log('UPDATE ERROR', err);
            });
            db.close();
        });
    };
    DataBaseService = __decorate([
        core_1.Injectable()
    ], DataBaseService);
    return DataBaseService;
}());
exports.DataBaseService = DataBaseService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWJhc2Uuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImRhdGFiYXNlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxzQ0FBMkM7QUFDM0MsaUNBQWlDO0FBQ2pDLDJDQUEyQztBQUMzQyxJQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMscUJBQXFCLENBQUMsQ0FBQztBQUc5QztJQUFBO0lBeU9BLENBQUM7SUF0T0csc0NBQVksR0FBWjtRQUFBLGlCQVlDO1FBWEcsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxjQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQyxFQUFFO1lBQ2hDLEtBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFDO1lBQ25CLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSSxDQUFDLGlCQUFpQixDQUFDLGNBQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDbkQsS0FBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7WUFDOUIsQ0FBQztZQUNELEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSSxDQUFDLGlCQUFpQixDQUFDLGNBQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDbkQsS0FBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7WUFDL0IsQ0FBQztRQUNMLENBQUMsRUFBRSxVQUFDLEtBQUs7WUFDTCxLQUFLLENBQUMsc0NBQXNDLENBQUMsQ0FBQztRQUNsRCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFDRCw0Q0FBa0IsR0FBbEI7UUFDSSxDQUFDLElBQUksTUFBTSxDQUFDLGNBQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFDLEVBQUU7WUFDaEMsMkNBQTJDO1lBQzNDLEVBQUUsQ0FBQyxPQUFPLENBQUMsY0FBTSxDQUFDLDBCQUEwQixDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUMsRUFBRTtnQkFDbEQsc0NB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QztZQUN0QixVQUFVLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQzNCLFVBQVUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDcEIsRUFBRSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUMsTUFBTTtnQkFDNUMsc0NBQXNDO2dCQUN0QyxPQUFPLENBQUMsR0FBRyxDQUFDLCtCQUErQixFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQ3pELENBQUMsRUFBRSxVQUFDLEdBQUc7Z0JBQ0gsc0NBQXNDO2dCQUN0QyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUNyQyxDQUFDLENBQUMsQ0FBQztZQUNILEVBQUUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNmLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQXhPUSxlQUFlO1FBRDNCLGlCQUFVLEVBQUU7T0FDQSxlQUFlLENBeU8zQjtJQUFELHNCQUFDO0NBQUEsQUF6T0QsSUF5T0M7QUF6T1ksMENBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBDb25maWcgfSBmcm9tICcuL2luZGV4Jztcbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby12YXItcmVxdWlyZXNcbmNvbnN0IFNxbGl0ZSA9IHJlcXVpcmUoJ25hdGl2ZXNjcmlwdC1zcWxpdGUnKTtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIERhdGFCYXNlU2VydmljZSB7XG4gICAgcHJpdmF0ZSBkYXRhYmFzZTogYW55O1xuICAgIHByaXZhdGUgdW5zZW50TWVzc2FnZXM6IGFueTtcbiAgICBjcmVhdGVUYWJsZXMoKSB7XG4gICAgICAgIChuZXcgU3FsaXRlKENvbmZpZy5kYk5hbWUpKS50aGVuKChkYikgPT4ge1xuICAgICAgICAgICAgdGhpcy5kYXRhYmFzZSA9IGRiO1xuICAgICAgICAgICAgaWYgKCF0aGlzLmNoZWNrSWZUYWJsZUV4aXN0KENvbmZpZy5jb250YWN0VGFibGVOYW1lKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlQ29udGFjdFRhYmxlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIXRoaXMuY2hlY2tJZlRhYmxlRXhpc3QoQ29uZmlnLm1lc3NhZ2VUYWJsZU5hbWUpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jcmVhdGVNZXNzYWdlc1RhYmxlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgYWxlcnQoJ0NvdWxkIE5vdCBjcmVhdGUgYSBjb25uZWN0aW9uIHRvIERCLicpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgY3JlYXRlQ29udGFjdFRhYmxlKCkge1xuICAgICAgICAobmV3IFNxbGl0ZShDb25maWcuZGJOYW1lKSkudGhlbigoZGIpID0+IHtcbiAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbiAgICAgICAgICAgIGRiLmV4ZWNTUUwoQ29uZmlnLmNvbnRhY3RzVGFibGVDcmVhdGlvblF1ZXJ5KS50aGVuKChpZCkgPT4ge1xuICAgICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1jb25zb2xlXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0NvbnRhY3RzIFRBQkxFIENSRUFURUQgU1VDQ0VTU0ZVTExZJyk7XG4gICAgICAgICAgICAgICAgZGIuY2xvc2UoKTtcbiAgICAgICAgICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1jb25zb2xlXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0NSRUFURSBUQUJMRSBFUlJPUicsIGVycm9yKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9LCAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdlcnJvciBpbiBjcmVhdGluZyBkYiBjb25uZWN0aW9uLicpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgY3JlYXRlTWVzc2FnZXNUYWJsZSgpIHtcbiAgICAgICAgKG5ldyBTcWxpdGUoQ29uZmlnLmRiTmFtZSkpLnRoZW4oKGRiKSA9PiB7XG4gICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG4gICAgICAgICAgICBkYi5leGVjU1FMKENvbmZpZy5tZXNzYWdlc1RhYmxlQ3JlYXRpb25RdWVyeSkudGhlbigoaWQpID0+IHtcbiAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tY29uc29sZVxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdNZXNzYWdlcyBUQUJMRSBDUkVBVEVEIFNVQ0NFU1NGVUxMWScsIGlkKTtcbiAgICAgICAgICAgICAgICBkYi5jbG9zZSgpO1xuICAgICAgICAgICAgICAgIC8vIHRoaXMuZ2V0Q2hhdE1lc3NhZ2VzRnJvbVNlcnZpY2UoKTtcbiAgICAgICAgICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1jb25zb2xlXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ01lc3NhZ2VzIFRBQkxFIENvdWxkIE5vdCBiZSBDUkVBVEVEJywgZXJyb3IpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ2Vycm9yIGluIGNyZWF0aW5nIGRiIGNvbm5lY3Rpb24uJyk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBjaGVja0lmVGFibGVFeGlzdCh0YWJsZU5hbWUpIHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuICAgICAgICBjb25zdCBkaXN0aW5jdFF1ZXJ5ID0gJ3NlbGVjdCBESVNUSU5DVCB0YmxfbmFtZSBmcm9tIHNxbGl0ZV9tYXN0ZXIgd2hlcmUgdGJsX25hbWUgPSA/JztcbiAgICAgICAgKG5ldyBTcWxpdGUoQ29uZmlnLmRiTmFtZSkpLnRoZW4oKGRiKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmRhdGFiYXNlID0gZGI7XG4gICAgICAgICAgICBjb25zdCBjaGVja1RhYmxlUXVlcnkgPSBkaXN0aW5jdFF1ZXJ5O1xuICAgICAgICAgICAgdGhpcy5kYXRhYmFzZS5leGVjU1FMKGNoZWNrVGFibGVRdWVyeSwgW3RhYmxlTmFtZV0pXG4gICAgICAgICAgICAgICAgLnRoZW4oKHJlc3VsdHNldCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHJvdyBpbiByZXN1bHRzZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHRzZXQuaGFzT3duUHJvcGVydHkoJ3JvdycpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBpbnNlcnRJbnRvQ2hhdHMoY2hhdCkge1xuICAgICAgICBjb25zdCBpbnNlcnRRdWVyeSA9IGBcbiAgICAgICAgICBJTlNFUlQgSU5UTyBjb250YWN0c1xuICAgICAgICAgICggbnVtYmVyLCBuYW1lLCBhdmF0YXIsIHRleHQsIHR5cGUsIG11dGVkLFxuICAgICAgICAgICAgbGFzdFNlZW4sIHVucmVhZCwgbGFzdF9tZXNzYWdlX3RpbWVzdGFtcCApXG4gICAgICAgICAgVkFMVUVTICg/LCA/LCA/LCA/LCA/LCA/LCA/LCA/LCA/KWA7XG4gICAgICAgIGNvbnN0IHVwZGF0ZVF1ZXJ5ID0gYFxuICAgICAgICAgIFVQREFURSBjb250YWN0c1xuICAgICAgICAgIFNFVCBudW1iZXIgPSA/LCBuYW1lID0gPyxcbiAgICAgICAgICBhdmF0YXIgPT8sIHRleHQgPSA/LCB0eXBlID0gPywgbXV0ZWQgPSA/LCBsYXN0U2VlbiA9ID8sIHVucmVhZCA9ID8sXG4gICAgICAgICAgbGFzdF9tZXNzYWdlX3RpbWVzdGFtcCA9ID9cbiAgICAgICAgICBXSEVSRSBudW1iZXIgPSA/XG4gICAgICAgIGA7XG4gICAgICAgIGNvbnN0IGluc2VydEpTT04gPSBbXTtcbiAgICAgICAgaW5zZXJ0SlNPTi5wdXNoKGNoYXQubnVtYmVyKTtcbiAgICAgICAgaW5zZXJ0SlNPTi5wdXNoKGNoYXQuY29udGFjdC5uYW1lKTtcbiAgICAgICAgaW5zZXJ0SlNPTi5wdXNoKGNoYXQuY29udGFjdC5hdmF0YXIpO1xuICAgICAgICBpbnNlcnRKU09OLnB1c2goY2hhdC50ZXh0KTtcbiAgICAgICAgaW5zZXJ0SlNPTi5wdXNoKGNoYXQudHlwZSk7XG4gICAgICAgIGluc2VydEpTT04ucHVzaChjaGF0Lm11dGVkKTtcbiAgICAgICAgaW5zZXJ0SlNPTi5wdXNoKGNoYXQud2hlbik7XG4gICAgICAgIGluc2VydEpTT04ucHVzaChjaGF0LnVucmVhZCk7XG4gICAgICAgIGluc2VydEpTT04ucHVzaChjaGF0Lmxhc3RfbWVzc2FnZV90aW1lc3RhbXApO1xuICAgICAgICAobmV3IFNxbGl0ZShDb25maWcuZGJOYW1lKSkudGhlbigoZGIpID0+IHtcbiAgICAgICAgICAgIGRiLmV4ZWNTUUwoaW5zZXJ0UXVlcnksIGluc2VydEpTT04pLnRoZW4oKGlkKSA9PiB7XG4gICAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWNvbnNvbGVcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnSU5TRVJUIFJFU1VMVCcsIGlkKTtcbiAgICAgICAgICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1jb25zb2xlXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0lOU0VSVCBFUlJPUicsIGVycm9yKTtcbiAgICAgICAgICAgICAgICBjb25zdCB1cGRhdGVKU09OID0gaW5zZXJ0SlNPTjtcbiAgICAgICAgICAgICAgICB1cGRhdGVKU09OLnB1c2goY2hhdC5udW1iZXIpO1xuICAgICAgICAgICAgICAgIHRoaXMuZGF0YWJhc2UuZXhlY1NRTCh1cGRhdGVRdWVyeSwgdXBkYXRlSlNPTikudGhlbigoaWQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWNvbnNvbGVcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1VQREFURSBSRVNVTFQgQ2hhdHMnLCBpZCk7XG4gICAgICAgICAgICAgICAgfSwgKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tY29uc29sZVxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnVVBEQVRFIEVSUk9SJywgZXJyKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgZGIuY2xvc2UoKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGluc2VydEludG9NZXNzYWdlcyhtZXNzYWdlKSB7XG4gICAgICAgIGNvbnN0IGluc2VydFF1ZXJ5ID0gYFxuICAgICAgICAgICAgSU5TRVJUIElOVE8gbWVzc2FnZXNcbiAgICAgICAgICAgICggbWVzc2FnZVRleHQsIHNlbmRlciwgY3JlYXRlZFRpbWUsIHNlbnQsIGNvbnRhY3QpXG4gICAgICAgICAgICBWQUxVRVMgKD8sID8sID8sID8sID8pYDtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuICAgICAgICBjb25zdCBpbnNlcnRKU09OID0gW107XG4gICAgICAgIGluc2VydEpTT04ucHVzaChtZXNzYWdlLnRleHQpO1xuICAgICAgICBpbnNlcnRKU09OLnB1c2gocGFyc2VJbnQobWVzc2FnZS5zZW5kZXIsIDEwKSk7XG4gICAgICAgIGluc2VydEpTT04ucHVzaChwYXJzZUZsb2F0KG1lc3NhZ2UuY3JlYXRlZCkpO1xuICAgICAgICBpbnNlcnRKU09OLnB1c2gocGFyc2VJbnQobWVzc2FnZS5zZW50LCAxMCkpO1xuICAgICAgICBpbnNlcnRKU09OLnB1c2gobWVzc2FnZS5jb250YWN0KTtcbiAgICAgICAgKG5ldyBTcWxpdGUoQ29uZmlnLmRiTmFtZSkpLnRoZW4oKGRiKSA9PiB7XG4gICAgICAgICAgICBkYi5leGVjU1FMKGluc2VydFF1ZXJ5LCBpbnNlcnRKU09OKS50aGVuKChpZCkgPT4ge1xuICAgICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1jb25zb2xlXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0lOU0VSVCBNRXNzYWdlIFJFU1VMVCcsIGlkKTtcbiAgICAgICAgICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1jb25zb2xlXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0lOU0VSVCBFUlJPUicsIGVycm9yKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgZGIuY2xvc2UoKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGluc2VydEludG9NZXNzYWdlc1dpdGhNZXNzYWdlSWQobWVzc2FnZSkge1xuICAgICAgICBjb25zdCBpbnNlcnRRdWVyeSA9IGBcbiAgICAgICAgICAgIElOU0VSVCBJTlRPIG1lc3NhZ2VzXG4gICAgICAgICAgICAoIG1lc3NhZ2VUZXh0LCBzZW5kZXIsIGNyZWF0ZWRUaW1lLCBzZW50LCBjb250YWN0LCBtZXNzYWdlSWQpXG4gICAgICAgICAgICBWQUxVRVMgKD8sID8sID8sID8sID8sID8pYDtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuICAgICAgICBjb25zdCBpbnNlcnRKU09OID0gW107XG4gICAgICAgIGluc2VydEpTT04ucHVzaChtZXNzYWdlLnRleHQpO1xuICAgICAgICBpbnNlcnRKU09OLnB1c2gocGFyc2VJbnQobWVzc2FnZS5zZW5kZXIsIDEwKSk7XG4gICAgICAgIGluc2VydEpTT04ucHVzaChwYXJzZUZsb2F0KG1lc3NhZ2UuY3JlYXRlZCkpO1xuICAgICAgICBpbnNlcnRKU09OLnB1c2gocGFyc2VJbnQobWVzc2FnZS5zZW50LCAxMCkpO1xuICAgICAgICBpbnNlcnRKU09OLnB1c2gobWVzc2FnZS5jb250YWN0KTtcbiAgICAgICAgaW5zZXJ0SlNPTi5wdXNoKG1lc3NhZ2UubWVzc2FnZV9pZCk7XG4gICAgICAgIChuZXcgU3FsaXRlKENvbmZpZy5kYk5hbWUpKS50aGVuKChkYikgPT4ge1xuICAgICAgICAgICAgZGIuZXhlY1NRTChpbnNlcnRRdWVyeSwgaW5zZXJ0SlNPTikudGhlbigoaWQpID0+IHtcbiAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tY29uc29sZVxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdJTlNFUlQgTUVzc2FnZSBSRVNVTFQnLCBpZCk7XG4gICAgICAgICAgICB9LCAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tY29uc29sZVxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdJTlNFUlQgRVJST1InLCBlcnJvcik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGRiLmNsb3NlKCk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICB1cGRhdGVTdGF0dXNPZk1lc3NhZ2Uoc3RhdHVzLCBpZCkge1xuICAgICAgICAobmV3IFNxbGl0ZShDb25maWcuZGJOYW1lKSkudGhlbigoZGIpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZVF1ZXJ5ID0gYFxuICAgICAgICAgICAgICAgIFVQREFURSBtZXNzYWdlc1xuICAgICAgICAgICAgICAgIFNFVCBzZW50ID0gP1xuICAgICAgICAgICAgICAgIFdIRVJFIGlkID0gP2A7XG4gICAgICAgICAgICBjb25zdCB1cGRhdGVKU09OID0gW107XG4gICAgICAgICAgICB1cGRhdGVKU09OLnB1c2goc3RhdHVzKTtcbiAgICAgICAgICAgIHVwZGF0ZUpTT04ucHVzaChpZCk7XG4gICAgICAgICAgICBkYi5leGVjU1FMKHVwZGF0ZVF1ZXJ5LCB1cGRhdGVKU09OKS50aGVuKCh1bmlxaWQpID0+IHtcbiAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tY29uc29sZVxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdVUERBVEUgU0VOVCBTVEFUVVMgT0YgTUVTU0FHRVMnLCB1bmlxaWQpO1xuICAgICAgICAgICAgfSwgKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1jb25zb2xlXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1VQREFURSBFUlJPUicsIGVycik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGRiLmNsb3NlKCk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICB1cGRhdGVTZW50VGltZU9mTWVzc2FnZShzZW50VGltZSwgaWQpIHtcbiAgICAgICAgKG5ldyBTcWxpdGUoQ29uZmlnLmRiTmFtZSkpLnRoZW4oKGRiKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB1cGRhdGVRdWVyeSA9IGBcbiAgICAgICAgICAgICAgICBVUERBVEUgbWVzc2FnZXNcbiAgICAgICAgICAgICAgICBTRVQgc2VudFRpbWUgPSA/XG4gICAgICAgICAgICAgICAgV0hFUkUgaWQgPSA/YDtcbiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZUpTT04gPSBbXTtcbiAgICAgICAgICAgIHVwZGF0ZUpTT04ucHVzaChzZW50VGltZSk7XG4gICAgICAgICAgICB1cGRhdGVKU09OLnB1c2goaWQpO1xuICAgICAgICAgICAgZGIuZXhlY1NRTCh1cGRhdGVRdWVyeSwgdXBkYXRlSlNPTikudGhlbigodW5pcWlkKSA9PiB7XG4gICAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWNvbnNvbGVcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnVVBEQVRFIFNFTlQgU1RBVFVTIE9GIE1FU1NBR0VTJywgdW5pcWlkKTtcbiAgICAgICAgICAgIH0sIChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tY29uc29sZVxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdVUERBVEUgRVJST1InLCBlcnIpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBkYi5jbG9zZSgpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgdXBkYXRlRGVsaXZlcnlUaW1lT2ZNZXNzYWdlKGRlbGl2ZXJ5VGltZSwgaWQpIHtcbiAgICAgICAgKG5ldyBTcWxpdGUoQ29uZmlnLmRiTmFtZSkpLnRoZW4oKGRiKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB1cGRhdGVRdWVyeSA9IGBcbiAgICAgICAgICAgICAgICBVUERBVEUgbWVzc2FnZXNcbiAgICAgICAgICAgICAgICBTRVQgZGVsaXZlcmVkVGltZSA9ID9cbiAgICAgICAgICAgICAgICBXSEVSRSBpZCA9ID9gO1xuICAgICAgICAgICAgY29uc3QgdXBkYXRlSlNPTiA9IFtdO1xuICAgICAgICAgICAgdXBkYXRlSlNPTi5wdXNoKGRlbGl2ZXJ5VGltZSk7XG4gICAgICAgICAgICB1cGRhdGVKU09OLnB1c2goaWQpO1xuICAgICAgICAgICAgZGIuZXhlY1NRTCh1cGRhdGVRdWVyeSwgdXBkYXRlSlNPTikudGhlbigodW5pcWlkKSA9PiB7XG4gICAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWNvbnNvbGVcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnVVBEQVRFIFNFTlQgU1RBVFVTIE9GIE1FU1NBR0VTJywgdW5pcWlkKTtcbiAgICAgICAgICAgIH0sIChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tY29uc29sZVxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdVUERBVEUgRVJST1InLCBlcnIpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBkYi5jbG9zZSgpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgdXBkYXRlTWVzc2FlSWRPZk1lc3NhZ2UobWVzc2FnZUlkLCBpZCkge1xuICAgICAgICAobmV3IFNxbGl0ZShDb25maWcuZGJOYW1lKSkudGhlbigoZGIpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZVF1ZXJ5ID0gYFxuICAgICAgICAgICAgICAgIFVQREFURSBtZXNzYWdlc1xuICAgICAgICAgICAgICAgIFNFVCBtZXNzYWdlSWQgPSA/XG4gICAgICAgICAgICAgICAgV0hFUkUgaWQgPSA/YDtcbiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZUpTT04gPSBbXTtcbiAgICAgICAgICAgIHVwZGF0ZUpTT04ucHVzaChtZXNzYWdlSWQpO1xuICAgICAgICAgICAgdXBkYXRlSlNPTi5wdXNoKGlkKTtcbiAgICAgICAgICAgIGRiLmV4ZWNTUUwodXBkYXRlUXVlcnksIHVwZGF0ZUpTT04pLnRoZW4oKHVuaXFpZCkgPT4ge1xuICAgICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1jb25zb2xlXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ01lc3NhZ2UgSWQgVXBkYXRlZCBPRiBNRVNTQUdFJywgdW5pcWlkKTtcbiAgICAgICAgICAgIH0sIChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tY29uc29sZVxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdVUERBVEUgRVJST1InLCBlcnIpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBkYi5jbG9zZSgpO1xuICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=